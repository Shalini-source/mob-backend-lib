name: Mirror Maven Artifact with Dependencies

on:
  workflow_dispatch:
    inputs:
      group_id:
        description: 'Group ID (e.g. org.apache.commons)'
        required: true
      artifact_id:
        description: 'Artifact ID (e.g. commons-lang3)'
        required: true
      version:
        description: 'Version (e.g. 3.14.0)'
        required: true

jobs:
  mirror-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: '17'

      - name: Configure Maven settings
        run: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml <<EOF
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.PAT_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF

      - name: Create temp pom.xml
        run: |
          mkdir -p temp
          cat > temp/pom.xml <<EOF
          <project>
            <modelVersion>4.0.0</modelVersion>
            <groupId>mirror</groupId>
            <artifactId>mirror-artifact</artifactId>
            <version>1.0.0</version>
            <dependencies>
              <dependency>
                <groupId>${{ github.event.inputs.group_id }}</groupId>
                <artifactId>${{ github.event.inputs.artifact_id }}</artifactId>
                <version>${{ github.event.inputs.version }}</version>
              </dependency>
            </dependencies>
          </project>
          EOF

      - name: Create artifact directories
        run: |
          mkdir -p ./artifact/jars
          mkdir -p ./artifact/poms

      - name: Download transitive JARs
        run: |
          mvn -f temp/pom.xml dependency:copy-dependencies \
            -DoutputDirectory=./artifact/jars

      - name: List transitive dependencies
        run: |
          mvn -f temp/pom.xml dependency:list \
            -DincludeScope=runtime \
            -DoutputFile=deps.txt \
            -DappendOutput=true

      - name: Debug deps.txt contents
        run: |
          echo "üìÑ Contents of deps.txt:"
          cat deps.txt || echo "‚ö†Ô∏è deps.txt not found or is empty"

      - name: Download POMs for dependencies
        run: |
          grep ":" deps.txt | while read dep; do
            mvn -f temp/pom.xml dependency:get -Dartifact=$dep:pom -Dtransitive=false
            mvn -f temp/pom.xml dependency:copy -Dartifact=$dep:pom -DoutputDirectory=./artifact/poms
          done

      - name: Verify downloaded jars
        run: ls -lh ./artifact/jars || echo "‚ö†Ô∏è No JARs found"

      - name: Verify downloaded poms
        run: ls -lh ./artifact/poms || echo "‚ö†Ô∏è No POMs found"

      - name: Publish JARs and POMs
        run: |
          for jar in ./artifact/jars/*.jar; do
            base=$(basename "$jar" .jar)
            pom=./artifact/poms/${base}.pom
            if [[ -f "$pom" ]]; then
              mvn deploy:deploy-file \
                -Dfile=$jar \
                -DpomFile=$pom \
                -DrepositoryId=github \
                -Durl=https://maven.pkg.github.com/Shalini-source/mob-backend-lib
            else
              echo "‚ö†Ô∏è Skipping $jar ‚Äî POM not found"
            fi
          done
